<!DOCTYPE html>
<html lang="pt-br">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1">
    <title>Teleatendimento 193 COBOM</title>
    
    <link href="https://cdn.jsdelivr.net/npm/bootstrap@5.3.0/dist/css/bootstrap.min.css" rel="stylesheet">
    <link rel="stylesheet" href="https://cdn.jsdelivr.net/npm/bootstrap-icons@1.10.0/font/bootstrap-icons.css">
    
    <link rel="preconnect" href="https://fonts.googleapis.com">
    <link rel="preconnect" href="https://fonts.gstatic.com" crossorigin>
    <link href="https://fonts.googleapis.com/css2?family=Montserrat:wght@400;700&family=Source+Sans+Pro:wght@400;600;700&display=swap" rel="stylesheet">

    <style>
        /* =========================================
           ESTILOS (STYLES.CSS INTEGRADO)
           ========================================= */
        
        /* Variáveis Globais */
        :root {
            --primary: #2f5dff;
            --primary-light: #e6ecff;
            --bg: #f5f7fb;
            --text: #111827;
            --text-muted: #6b7280;
            --card-bg: #ffffff;
            --border-soft: #e5e7eb;
            --radius: 18px;
            --shadow-soft: 0 10px 25px rgba(15, 23, 42, 0.08);
            --shadow-hover: 0 16px 45px rgba(15, 23, 42, 0.15);
        }

        /* Reset básico */
        *, *::before, *::after {
            margin: 0;
            padding: 0;
            box-sizing: border-box;
        }

        body {
            font-family: "Source Sans Pro", system-ui, sans-serif;
            background: var(--bg);
            color: var(--text);
            -webkit-font-smoothing: antialiased;
        }

        .page {
            min-height: 100vh;
            display: flex;
            flex-direction: column;
        }

        /* ===== TOPBAR ===== */
        .topbar {
            width: 100%;
            background: #ffffff;
            box-shadow: 0 1px 0 rgba(0, 0, 0, 0.06);
            position: sticky;
            top: 0;
            z-index: 1040;
            height: 70px;
            display: flex;
            align-items: center;
        }

        .topbar-inner {
            width: 100%;
            padding: 0 28px;
            display: flex;
            align-items: center;
            justify-content: space-between;
        }

        /* Logo */
        .logo-wrapper {
            display: flex;
            align-items: center;
            font-family: "Montserrat", sans-serif;
            font-weight: 700;
            font-size: 20px;
            color: var(--primary);
        }

        .logo-wrapper i {
            font-size: 24px;
            margin-right: 10px;
        }

        /* Relógio */
        .clock-wrapper {
            text-align: right;
            font-size: 14px;
        }

        .clock-time {
            font-weight: 700;
            font-size: 20px;
            color: var(--text);
        }

        .clock-date {
            color: var(--text-muted);
            margin-top: 2px;
        }

        /* ===== LAYOUT PRINCIPAL ===== */
        .app-container {
            display: flex;
            min-height: calc(100vh - 70px);
            margin-top: 0;
        }

        /* SIDEBAR */
        #sidebar {
            width: 290px;
            min-width: 260px;
            background-color: #ffffff;
            border-right: 1px solid var(--border-soft);
            display: flex;
            flex-direction: column;
            z-index: 1030;
            padding: 20px 10px;
        }

        #sidebar h4 {
            font-family: "Montserrat", sans-serif;
            font-size: 16px;
            font-weight: 700;
            color: var(--text);
            margin-bottom: 20px;
            padding-left: 10px;
            display: flex;
            align-items: center;
            gap: 10px;
        }

        #main-menu {
            list-style: none;
            padding: 0;
        }

        #main-menu .nav-link {
            color: var(--text-muted);
            padding: 12px 15px;
            border-radius: 10px;
            display: flex;
            align-items: center;
            font-weight: 600;
            transition: all 0.2s ease;
            text-decoration: none;
            margin-bottom: 5px;
        }

        #main-menu .nav-link i {
            font-size: 1.1rem;
            margin-right: 12px;
            width: 20px;
            text-align: center;
        }

        #main-menu .nav-link:hover {
            background: var(--primary-light);
            color: var(--primary);
        }

        #main-menu .nav-link.active {
            background: var(--primary);
            color: #ffffff;
            box-shadow: 0 4px 12px rgba(47, 93, 255, 0.3);
        }

        /* CONTEUDO PRINCIPAL */
        #decision-tree-container {
            flex: 1;
            padding: 30px;
            background-color: var(--bg);
            overflow-y: auto;
        }

        /* CARD PRINCIPAL */
        .card.decision-card {
            background: var(--card-bg);
            border-radius: var(--radius);
            box-shadow: var(--shadow-soft);
            border: none;
            overflow: hidden;
            transition: transform 0.18s ease, box-shadow 0.18s ease;
        }
        
        .card.decision-card .card-header {
            background: #ffffff !important;
            border-bottom: 1px solid var(--border-soft);
            padding: 20px 30px;
            color: var(--primary);
        }

        .card.decision-card .card-header h2 {
            font-family: "Montserrat", sans-serif;
            font-size: 22px;
            font-weight: 700;
            margin: 0;
            color: var(--text);
            display: flex;
            align-items: center;
            justify-content: center;
            gap: 10px;
        }
        
        .card.decision-card .card-header i {
            color: var(--primary);
        }

        .card-body {
            padding: 30px;
        }

        /* ===== COMPONENTES INTERNOS ===== */
        
        /* Botões de Opção */
        .option-btn {
            background-color: #ffffff;
            color: var(--text);
            border: 1px solid var(--border-soft);
            padding: 15px 25px;
            border-radius: 12px;
            font-weight: 600;
            font-size: 16px;
            margin: 8px;
            transition: all 0.2s ease;
            box-shadow: 0 2px 5px rgba(0,0,0,0.05);
            min-width: 200px;
            text-align: left;
            display: inline-flex;
            align-items: center;
        }

        .option-btn i {
            color: var(--primary);
            margin-right: 10px;
            font-size: 1.2rem;
        }

        .option-btn:hover {
            background-color: var(--primary);
            color: white;
            transform: translateY(-3px);
            box-shadow: var(--shadow-hover);
            border-color: var(--primary);
        }

        .option-btn:hover i {
            color: white;
        }

        /* Botões de Ação */
        #back-btn, #copy-btn, #save-call-btn, .samu-btn {
            border-radius: 8px;
            font-weight: 600;
            padding: 10px 20px;
            transition: all 0.2s;
        }
        
        .samu-btn {
            background-color: var(--primary);
            border: none;
        }

        /* Texto e Orientações */
        #question {
            font-family: "Montserrat", sans-serif;
            font-weight: 700;
            color: var(--text);
            font-size: 1.5rem;
            margin-bottom: 20px;
        }

        #guidance {
            background-color: var(--primary-light);
            border-left: 4px solid var(--primary);
            padding: 20px;
            border-radius: 8px;
            margin: 20px 0;
            color: var(--text);
        }
        
        .guidance-icon {
            color: var(--primary);
        }

        /* Inputs e Textareas */
        .form-control, .samu-input {
            border-radius: 12px;
            border: 1px solid var(--border-soft);
            padding: 15px;
            background-color: #f9fafb;
        }

        /* --- ALTERAÇÃO AQUI: AUMENTO DO NOTEPAD --- */
        #notes-area {
            border-radius: 12px;
            border: 1px solid var(--border-soft);
            padding: 15px;
            background-color: #f9fafb;
            min-height: 250px; /* Aumentado para ~10-12 linhas (antes era menor) */
            font-size: 1rem;
            line-height: 1.5;
        }
        
        .form-control:focus, .samu-input:focus, #notes-area:focus {
            background-color: #fff;
            border-color: var(--primary);
            box-shadow: 0 0 0 4px rgba(47, 93, 255, 0.1);
        }

        /* Histórico */
        #history-panel {
            background-color: var(--bg);
            border: 1px solid var(--border-soft);
            border-radius: 12px;
            padding: 20px;
        }

        pre {
            background-color: #fff;
            border: 1px solid var(--border-soft);
            border-radius: 8px;
            padding: 15px;
            color: var(--text-muted);
            white-space: pre-wrap;
        }

        /* Responsividade */
        @media (max-width: 992px) {
            .app-container {
                flex-direction: column;
            }
            #sidebar {
                width: 100%;
                border-right: none;
                border-bottom: 1px solid var(--border-soft);
                padding: 10px;
            }
            #sidebar h4 {
                margin-bottom: 10px;
            }
            .topbar-inner {
                padding: 0 15px;
            }
        }

        .static-guidance {
    background-color: var(--primary-light);
    border-left: 4px solid var(--primary);
    padding: 20px;
    border-radius: 8px;
    margin: 20px 0;
    color: var(--text);
}


        .logo-img {
    height: 120px;        /* ajuste conforme o tamanho do seu logo */
    width: auto;
    margin-right: 20px;
}
    
.static-guidance {
    background-color: var(--primary-light);
    border-left: 4px solid var(--primary);
    padding: 20px;
    border-radius: 8px;
    margin: 20px 0;
    color: var(--text);
}

</style>
</head>
<body>

    <div class="topbar">
        <div class="topbar-inner">
           <div class="logo-wrapper">
    <img src="logo.png" alt="Logo" class="logo-img">
    <span>SISP Teleatendimento</span>
</div>
            <div class="clock-wrapper">
                <div class="clock-time" id="clock-display">00:00:00</div>
                <div class="clock-date" id="date-display">Carregando data...</div>
            </div>
        </div>
    </div>

    <div class="app-container">
        
        <div id="sidebar">
            <h4><i class="bi bi-menu-button-wide"></i> Menu de Ações</h4>
            <ul class="nav flex-column" id="main-menu">
                <li class="nav-item">
                    <a class="nav-link active" href="#" data-target="triagem">
                        <i class="bi bi-fire"></i> Triagem 193</a>
                </li>
                <li class="nav-item">
                    <a class="nav-link" href="#" data-target="dados-cad">
                        <i class="bi bi-clipboard2-check"></i> Registro CAD</a>
                </li>
                <li class="nav-item">
                    <a class="nav-link" href="#" data-target="rechamadas">
                        <i class="bi bi-telephone-plus"></i> Rechamadas</a>
                </li>
                <li class="nav-item">
                    <a class="nav-link" href="#" data-target="falha">
                        <i class="bi bi-bell-slash"></i> Falhas Com.</a>
                </li>
                <li class="nav-item">
                    <a class="nav-link" href="#" data-target="trote">
                        <i class="bi bi-emoji-angry"></i> Trotes</a>
                </li>
                <li class="nav-item">
                    <a class="nav-link" href="#" data-target="orgao">
                        <i class="bi bi-arrow-left-right"></i> Transf. PM/PC</a>
                </li>
                <li class="nav-item">
                    <a class="nav-link" href="#" data-target="samu">
                        <i class="bi bi-heart-pulse"></i> Transf. SAMU</a>
                </li>
                <li class="nav-item">
                    <a class="nav-link" href="#" data-target="busca-samu">
                        <i class="bi bi-search"></i> Busca SAMU</a>
                </li>
                <li class="nav-item">
                    <a class="nav-link" href="#" data-target="militar">
                        <i class="bi bi-telephone"></i> Contato Militar</a>
                </li>
                <li class="nav-item">
                    <a class="nav-link" href="#" data-target="queixas">
                        <i class="bi bi-chat-text"></i> Queixas</a>
                </li>
                <li class="nav-item">
                    <a class="nav-link" href="#" data-target="informacoes">
                        <i class="bi bi-info-circle"></i> Informações</a>
                </li>
                <li class="nav-item">
                    <a class="nav-link" href="#" data-target="saved-calls">
                        <i class="bi bi-archive"></i> Histórico</a>
                </li>
            </ul>
        </div>

        <div id="decision-tree-container">
            <div class="card decision-card">
                <div class="card-header">
                    <h2><i class="bi bi-diagram-3-fill"></i> POP Teleatendimento 193 - COBOM</h2>
                </div>
                <div class="card-body">

                    <div id="triagem" class="dynamic-content">
                        <div id="question-container">
                            <h3 id="question">Triagem de emergência 193</h3>
                            <div id="guidance">
                                </div>
                        </div>
                        <div id="options" class="d-flex flex-wrap justify-content-center">
                            </div>
                        <textarea id="notes-area" class="form-control mt-4" placeholder="Anotações da chamada (ex: SIT: Fogo na cozinha. VIT: 1 vítima consciente. REF: Prédio azul. TAC: 5 min.)..."></textarea>
                    </div>

                    <div id="dados-cad" class="dynamic-content" style="display:none;">
                        <div id="question-container">
                            <h3>Registro de Chamadas no CAD</h3>
                            <div class="static-guidance">
                                <p><i class="bi bi-info-circle-fill guidance-icon"></i><strong>Orientações:</strong></p>
                                <p><strong>Objetivo:</strong> Iniciar e registrar chamada no CAD com dados precisos.</p>
                                <ul>
                                    <li>Clicar no ícone do giroflex.</li>
                                    <li><strong>Telefone:</strong> Confirmar DDD.</li>
                                    <li><strong>Endereço:</strong> Logradouro, Número, Bairro, Município e Referências.</li>
                                </ul>
                            </div>
                        </div>
                    </div>

                    <div id="falha" class="dynamic-content" style="display:none;">
                        <div id="question-container">
                            <h3>Falhas na Comunicação</h3>
                            <div class="static-guidance">
                                <p><strong>Chamada Muda:</strong> Repetir saudação 3 vezes. Encerrar como "Falha > Solicitante mudo".</p>
                                <p><strong>Caiu:</strong> Qualificar como "Falha > Ligação caiu".</p>
                            </div>
                        </div>
                    </div>

                    <div id="trote" class="dynamic-content" style="display:none;">
                        <div id="question-container">
                            <h3>Gerenciamento de Trote</h3>
                            <div class="static-guidance"><p>Avisar sobre rastreamento/responsabilização. Transferir para Supervisor.</p></div>
                        </div>
                    </div>

                    <div id="orgao" class="dynamic-content" style="display:none;">
                        <div id="question-container">
                            <h3>Transferência PM/PC</h3>
                            <div class="static-guidance"><p>Transferir para <strong>190 (PMMG)</strong> ou <strong>197 (PCMG)</strong>.</p></div>
                        </div>
                    </div>

                    <div id="samu" class="dynamic-content" style="display:none;">
                        <div id="question-container">
                            <h3>Transferência SAMU</h3>
                            <div class="static-guidance">
                                <p>192 (BH), 403 (Betim), 404 (Contagem), 405 (Sete Lagoas), 406 (Divinópolis).</p>
                            </div>
                        </div>
                    </div>

                    <div id="busca-samu" class="dynamic-content" style="display:none;">
                        <div id="question-container">
                            <h3>Busca Municípios SAMU</h3><br>
                            <div class="samu-search-container d-flex">
                                <input type="text" id="municipioInput" class="samu-input flex-grow-1" placeholder="Nome do município...">
                                <button class="samu-btn ms-2 text-white" onclick="pesquisarMunicipio()">Pesquisar</button>
                            </div>
                            <div id="samu-result" class="samu-result mt-3"></div>
                        </div>
                    </div>

                    <div id="militar" class="dynamic-content" style="display:none;">
                        <div id="question-container">
                            <h3>Contato Militar</h3>
                            <div class="static-guidance"><p>Identificar patente/unidade. Criar chamada adm ou transferir.</p></div>
                        </div>
                    </div>

                    <div id="rechamadas" class="dynamic-content" style="display:none;">
                        <div id="question-container">
                            <h3>Rechamadas</h3>
                            <div class="static-guidance"><p>Atualizar dados e informar sobre prioridade.</p></div>
                        </div>
                    </div>

                    <div id="queixas" class="dynamic-content" style="display:none;">
                        <div id="question-container">
                            <h3>Queixas</h3>
                            <div class="static-guidance"><p>Orientar "Fale Conosco" no site ou transferir Supervisor se grave.</p></div>
                        </div>
                    </div>

                    <div id="informacoes" class="dynamic-content" style="display:none;">
                        <div id="question-container">
                            <h3>Informações</h3>
                            <div class="static-guidance"><p>Projetos sociais, AVCB: Transferir para setor responsável.</p></div>
                        </div>
                    </div>

                    <div id="saved-calls" class="dynamic-content" style="display:none;">
                        <div id="question-container">
                            <h3>Chamadas Salvas</h3>
                            <div id="saved-calls-list"></div>
                        </div>
                    </div>

                    <button id="back-btn" class="btn btn-secondary mt-4 d-none">
                        <i class="bi bi-arrow-left"></i> Voltar
                    </button>
                    
                    <div id="history-panel" class="text-start mt-4" style="display: none;">
                        <h4><i class="bi bi-journal-check guidance-icon"></i> Resumo do Atendimento</h4>
                        <div id="history-content"></div>
                        <div class="mt-3">
                            <button id="copy-btn" class="btn btn-sm btn-success">
                                <i class="bi bi-clipboard"></i> Copiar
                            </button>
                            <span id="copy-message" class="text-success ms-2" style="display:none;">Copiado!</span>
                            <button id="save-call-btn" class="btn btn-sm btn-primary ms-2">
                                <i class="bi bi-save"></i> Salvar
                            </button>
                            <span id="save-message" class="text-primary ms-2" style="display:none;">Salvo!</span>
                        </div>
                    </div>

                </div>
            </div>
        </div>
    </div>

    <script>
        // Relógio
        function updateClock() {
            const now = new Date();
            document.getElementById('clock-display').textContent = now.toLocaleTimeString('pt-BR');
            document.getElementById('date-display').textContent = now.toLocaleDateString('pt-BR', { weekday: 'long', day: 'numeric', month: 'long' });
        }
        setInterval(updateClock, 1000);
        updateClock();

        // Dados e Lógica
        const appData = {
            history: [], pathHistory: [], 
            gruposSamu: {
                "SAMU-BH": ["Belo Horizonte", "Belo Vale", "Caeté", "Confins", "Itabirito", "Jaboticatubas", "Lagoa Santa", "Mariana", "Matozinhos", "Moeda", "Nova Lima", "Nova União", "Ouro Preto", "Pedro Leopoldo", "Raposos", "Ribeirão das Neves", "Rio Acima", "Sabará", "Santa Luzia", "Santana do Riacho", "São José da Lapa", "Taquaraçu de Minas", "Vespasiano"],
                "SAMU-Divinópolis": ["Aguanil", "Araújos", "Arcos", "Bambuí", "Bom Despacho", "Bonfim", "Brumadinho", "Camacho", "Campo Belo", "Cana Verde", "Candeias", "Carmo da Mata", "Carmo do Cajuru, Carmópolis de Minas", "Cláudio", "Conceição do Pará", "Córrego Danta", "Córrego Fundo", "Cristais", "Crucilândia", "Divinópolis", "Dores do Indaiá", "Esmeraldas", "Estrela do Indaiá, Florestal", "Formiga", "Igarapé", "Igaratinga", "Iguatama", "Itaguara", "Itapecerica", "Itatiaiuçu", "Itaúna", "Japaraíba", "Juatuba", "Lagoa da Prata", "Leandro Ferreira", "Luz", "Mário Campos", "Martinho Campos", "Mateus Leme", "Medeiros", "Moema", "Nova Serrana", "Oliveira", "Onça de Pitangui", "Pains", "Pará de Minas", "Passa Tempo", "Pedra do Indaiá", "Perdigão", "Piedade dos Gerais", "Piracema", "Pitangui", "Rio Manso", "Santana do Jacaré", "Santo Antônio do Amparo", "Santo Antônio do Monte", "São Francisco de Paula", "São Gonçalo do Pará", "São Joaquim de Bicas", "São José da Varginha", "São Sebastião do Oeste", "Serra da Saudade", "Tapiraí"],
                "SAMU-Sete Lagoas": ["Araçaí", "Baldim", "Caetanópolis", "Cachoeira da Prata", "Cordisburgo", "Fortuna de Minas", "Inhaúma", "Jequitibá", "Maravilhas", "Papagaios", "Paraopeba", "Pompéu", "Santana de Pirapama", "Sete Lagoas"],
                "SAMU-Contagem": ["Contagem", "Ibirité", "Sarzedo"],
                "SAMU-Betim": ["Betim"]
            },
            treeData: {
                1: {
                    question: "Qual é a emergência?",
                    guidance: "<strong>Saudação:</strong> 'Bombeiros, emergência!'. <br><strong>5W+H:</strong> O que? Onde? Quem? Quando? Como? Por quê?",
                    options: [
                        { text: "Incêndio / Explosão", next: 2 },
                        { text: "Acidente / Mal Súbito", next: 20 },
                        { text: "Salvamento (Pessoa/Animal)", next: 30 },
                        { text: "Risco / Corte de Árvore / Insetos", next: 40 },
                        { text: "Outros Assuntos", next: 100 }
                    ]
                },
                2: { question: "Há pessoas feridas/perigo?", guidance: "<strong>Prioridade Máxima.</strong> Acionar Supervisor.", options: [{ text: "Sim", next: 3 }, { text: "Não/Não sabe", next: 4 }] },
                3: { question: "Há pessoas presas?", guidance: "<strong>Altíssimo Risco.</strong>", options: [{ text: "Sim", next: 4 }, { text: "Não", next: 4 }] },
                4: { question: "Risco explosão/desabamento?", options: [{ text: "Sim", next: 5 }, { text: "Não", next: 5 }] },
                5: { question: "Local do Incêndio?", options: [{ text: "Edificação", next: 6 }, { text: "Vegetação", next: 10 }, { text: "Veículo", next: 12 }, { text: "Elétrico", next: 16 }, { text: "Outros", next: 14 }] },
                6: { question: "Fogo visível?", options: [{ text: "Fogo visível", next: 7 }, { text: "Fumaça", next: 7 }, { text: "Não sabe", next: 8 }] },
                7: { question: "Extensão?", options: [{ text: "Múltiplos cômodos", next: 8 }, { text: "Um cômodo", next: 8 }] },
                8: { question: "Tipo edificação?", options: [{ text: "Público", next: 9 }, { text: "Residencial", next: 9 }, { text: "Comercial", next: 9 }] },
                9: { question: "Acesso caminhão?", options: [{ text: "Sim", next: 90 }, { text: "Não", next: 92 }] },
                10: { question: "Próximo a casas?", options: [{ text: "Sim <50m", next: 11 }, { text: "Não >50m", next: 11 }] },
                11: { question: "Tamanho?", options: [{ text: "Grande", next: 100 }, { text: "Pequeno", next: 100 }] },
                12: { question: "Veículo?", options: [{ text: "Carro/Moto", next: 13 }, { text: "Pesado", next: 13 }] },
                13: { question: "Fogo visível?", options: [{ text: "Sim", next: 14 }, { text: "Não", next: 14 }] },
                14: { question: "Vazamento?", options: [{ text: "Gás/Químico", next: 15 }, { text: "Não", next: 93 }] },
                15: { question: "Ambiente?", options: [{ text: "Fechado", next: 91 }, { text: "Aberto", next: 100 }] },
                16: { question: "CEMIG acionada?", options: [{ text: "Sim", next: 93 }, { text: "Não", next: 100 }] },
                20: { question: "Consciência?", options: [{ text: "Consciente", next: 21 }, { text: "Inconsciente", next: 21 }] },
                21: { question: "Respiração?", options: [{ text: "Normal", next: 22 }, { text: "PCR/Engasgo/Dispneia", next: 100 }] },
                22: { question: "Causa?", options: [{ text: "Clínica", next: 23 }, { text: "Trauma", next: 24 }] },
                23: { question: "Sinais choque?", options: [{ text: "Sim", next: 100 }, { text: "Estável", next: 100 }] },
                24: { question: "Hemorragia/Fratura?", options: [{ text: "Sim", next: 100 }, { text: "Leve", next: 100 }] },
                30: { question: "Pessoas risco?", options: [{ text: "Sim", next: 31 }, { text: "Não", next: 31 }] },
                31: { question: "Tipo?", options: [{ text: "Trânsito", next: 32 }, { text: "Água", next: 33 }, { text: "Desaparecido", next: 34 }, { text: "Suicídio", next: 35 }, { text: "Animal", next: 36 }] },
                32: { question: "Preso ferragens?", options: [{ text: "Sim", next: 100 }, { text: "Não", next: 100 }] },
                33: { question: "Visível?", options: [{ text: "Sim", next: 100 }, { text: "Não", next: 100 }] },
                34: { question: "Vulnerável?", options: [{ text: "Sim", next: 100 }, { text: "Não", next: 100 }] },
                35: { question: "Ativa?", options: [{ text: "Sim", next: 100 }, { text: "Histórico", next: 93 }] },
                36: { question: "Risco?", options: [{ text: "Sim", next: 100 }, { text: "Não", next: 93 }] },
                40: { question: "Risco?", options: [{ text: "Árvore", next: 41 }, { text: "Insetos", next: 42 }, { text: "Estrutura", next: 43 }, { text: "Deslizamento", next: 44 }, { text: "Fios", next: 45 }, { text: "Outros", next: 46 }] },
                41: { question: "Queda iminente?", options: [{ text: "Sim", next: 47 }, { text: "Não", next: 93 }] },
                42: { question: "Ataque?", options: [{ text: "Sim", next: 100 }, { text: "Não", next: 93 }] },
                43: { question: "Colapso?", options: [{ text: "Sim", next: 47 }, { text: "Não", next: 100 }] },
                44: { question: "Cedendo?", options: [{ text: "Sim", next: 47 }, { text: "Não", next: 100 }] },
                45: { question: "Energizado?", options: [{ text: "Sim", next: 47 }, { text: "Não", next: 100 }] },
                46: { question: "Risco vida?", options: [{ text: "Sim", next: 47 }, { text: "Não", next: 100 }] },
                47: { question: "Pessoas perigo?", options: [{ text: "Sim", next: 100 }, { text: "Não", next: 93 }] },
                90: { question: "Instruções Incêndio", guidance: "Sair abaixado, não usar elevador.", options: [] },
                91: { question: "Instruções Gás", guidance: "Evacuar, ventilar, não ligar luzes.", options: [] },
                92: { question: "Instruções Acesso", guidance: "Enviar batedor.", options: [] },
                93: { question: "Fim (Rotina)", guidance: "Dados coletados. Aguardar.", options: [] },
                100: { question: "Fim (Prioridade)", guidance: "Dados coletados. Acionar Supervisor se grave.", options: [] }
            }
        };

        function initApp() {
            loadNode(1); appData.history.push(1);
            setupMenuListeners();
        }

        function setupMenuListeners() {
            document.querySelectorAll('.nav-link').forEach(link => {
                link.addEventListener('click', function(e) {
                    e.preventDefault();
                    document.querySelectorAll('.nav-link').forEach(i => i.classList.remove('active'));
                    this.classList.add('active');
                    const target = this.getAttribute('data-target');
                    document.querySelectorAll('.dynamic-content').forEach(c => c.style.display = 'none');
                    document.getElementById(target).style.display = 'block';
                    if (target === 'busca-samu') clearSamuSearch();
                    else if (target === 'triagem') {
                        appData.history = []; appData.pathHistory = [];
                        document.getElementById('notes-area').value = '';
                        loadNode(1); appData.history.push(1);
                    } else if (target === 'saved-calls') loadSavedCalls();
                });
            });
        }

        function loadNode(id) { 
            const node = appData.treeData[id];
            if (!node) return;
            const triagem = document.getElementById('triagem');
            if (window.getComputedStyle(triagem).display !== 'none') {
                document.getElementById('question').textContent = node.question;
                const guide = document.getElementById('guidance');
                if (node.guidance) {
                    guide.innerHTML = `<p><i class="bi bi-info-circle-fill guidance-icon"></i> <strong>Orientações:</strong></p><p>${node.guidance}</p>`;
                    guide.style.display = 'block';
                } else guide.style.display = 'none';

                const opts = document.getElementById('options');
                opts.innerHTML = '';
                if (node.options && node.options.length > 0) {
                    node.options.forEach(o => {
                        const btn = document.createElement('button');
                        btn.className = 'btn option-btn';
                        btn.innerHTML = `<i class="bi bi-arrow-right-circle"></i> ${o.text}`;
                        btn.onclick = () => {
                            const notes = document.getElementById('notes-area');
                            let prefix = [20, 21, 22, 23, 24].includes(id) ? 'VIT: ' : 'SIT: ';
                            notes.value += `${prefix}${o.text}\n\n`;
                            appData.pathHistory.push({ question: node.question, answer: prefix + o.text });
                            appData.history.push(o.next);
                            loadNode(o.next);
                        };
                        opts.appendChild(btn);
                    });
                    document.getElementById('history-panel').style.display = 'none';
                } else {
                    showHistory();
                    document.getElementById('history-panel').style.display = 'block';
                    const restart = document.createElement('button');
                    restart.className = 'btn btn-success option-btn';
                    restart.innerHTML = '<i class="bi bi-arrow-repeat"></i> Nova Chamada';
                    restart.onclick = () => {
                        appData.history = []; appData.pathHistory = [];
                        document.getElementById('notes-area').value = '';
                        loadNode(1); appData.history.push(1);
                    };
                    opts.appendChild(restart);
                }
                
                const back = document.getElementById('back-btn');
                if (appData.history.length > 1) {
                    back.classList.remove('d-none');
                    back.onclick = () => {
                        appData.history.pop(); appData.pathHistory.pop();
                        const prev = appData.history[appData.history.length - 1];
                        let txt = '';
                        appData.pathHistory.forEach(s => txt += `${s.answer}\n\n`);
                        document.getElementById('notes-area').value = txt;
                        loadNode(prev);
                    };
                } else back.classList.add('d-none');
            }
        }

        function showHistory() {
            const hist = document.getElementById('history-content');
            hist.innerHTML = '';
            const container = document.createElement('div');
            appData.pathHistory.forEach((s, i) => {
                const item = document.createElement('div');
                item.className = 'mb-2 pb-2 border-bottom';
                item.innerHTML = `<strong>${i + 1}. ${s.question}</strong><br><span class="text-primary">↳ ${s.answer}</span>`;
                container.appendChild(item);
            });
            const finalDiv = document.createElement('div');
            const notes = document.getElementById('notes-area').value;
            finalDiv.innerHTML = `<pre id="final-summary-text">${gerarResumo(appData.pathHistory, notes)}</pre>`;
            container.appendChild(finalDiv);
            hist.appendChild(container);

            document.getElementById('copy-btn').onclick = () => {
                navigator.clipboard.writeText(document.getElementById('final-summary-text').textContent)
                    .then(() => {
                        const msg = document.getElementById('copy-message');
                        msg.style.display = 'inline';
                        setTimeout(() => msg.style.display = 'none', 2000);
                    });
            };
            document.getElementById('save-call-btn').onclick = saveCall;
        }

        function gerarResumo(path, notes) {
            let res = "=== HISTÓRICO ===\n";
            let sit=[], vit=[], ref=[], tac=[];
            path.forEach(s => {
                if (s.answer.startsWith('SIT:')) sit.push(s.answer.substring(4).trim());
                else if (s.answer.startsWith('VIT:')) vit.push(s.answer.substring(4).trim());
            });
            const rL = notes.match(/^REF:\s*(.*)$/gim);
            if (rL) rL.forEach(l => ref.push(l.replace(/^REF:\s*/i, '').trim()));
            const tL = notes.match(/^TAC:\s*(.*)$/gim);
            if (tL) tL.forEach(l => tac.push(l.replace(/^TAC:\s*/i, '').trim()));
            res += `SIT: ${sit.join('; ') || 'NI'}\nVIT: ${vit.join('; ') || 'NI'}\nREF: ${ref.join('; ') || 'NI'}\nTAC: ${tac.join('; ') || 'NI'}\n`;
            return res;
        }

        function saveCall() {
            const notes = document.getElementById('notes-area').value;
            const summary = gerarResumo(appData.pathHistory, notes);
            let calls = JSON.parse(localStorage.getItem('teleatendimento_saved_calls')) || [];
            calls.push({ id: Date.now(), timestamp: new Date().toISOString(), decisionPath: appData.pathHistory, notes: notes, summary: summary });
            localStorage.setItem('teleatendimento_saved_calls', JSON.stringify(calls));
            const msg = document.getElementById('save-message');
            msg.style.display = 'inline';
            setTimeout(() => {
                msg.style.display = 'none';
                appData.history = []; appData.pathHistory = [];
                document.getElementById('notes-area').value = '';
                loadNode(1); appData.history.push(1);
            }, 1000);
        }

        function loadSavedCalls() {
            const list = document.getElementById('saved-calls-list');
            list.innerHTML = '';
            let calls = JSON.parse(localStorage.getItem('teleatendimento_saved_calls')) || [];
            if (calls.length === 0) { list.innerHTML = '<p>Vazio.</p>'; return; }
            calls.sort((a, b) => new Date(b.timestamp) - new Date(a.timestamp));
            calls.forEach(c => {
                const d = document.createElement('div');
                d.className = 'card mb-2 p-3';
                d.style.cursor = 'pointer';
                d.innerHTML = `<strong>${new Date(c.timestamp).toLocaleString()}</strong><small>${c.summary.substring(0,80)}...</small>`;
                d.onclick = () => {
                    list.innerHTML = `<button class="btn btn-secondary mb-3" onclick="loadSavedCalls()">Voltar</button><pre>${c.summary}</pre><pre>${c.notes}</pre>`;
                };
                list.appendChild(d);
            });
        }

        function clearSamuSearch() { document.getElementById("municipioInput").value = ""; document.getElementById("samu-result").innerHTML = ""; }
        function pesquisarMunicipio() {
            const v = document.getElementById("municipioInput").value.trim().toLowerCase().normalize("NFD").replace(/[\u0300-\u036f]/g, "");
            if (v.length < 3) return;
            let html = '';
            for (const [g, ms] of Object.entries(appData.gruposSamu)) {
                const mat = ms.filter(m => m.toLowerCase().normalize("NFD").replace(/[\u0300-\u036f]/g, "").includes(v));
                if (mat.length > 0) html += `<div class="alert alert-info"><strong>${g}</strong>: ${mat.join(', ')}</div>`;
            }
            document.getElementById("samu-result").innerHTML = html || '<div class="alert alert-warning">Não encontrado. Transferir Supervisor.</div>';
        }
        document.getElementById("municipioInput").addEventListener("keyup", function(e) { if (e.key === "Enter") pesquisarMunicipio(); });
        document.addEventListener('DOMContentLoaded', initApp);
    </script>
</body>
</html>