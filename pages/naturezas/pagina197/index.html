<!DOCTYPE html>
<html lang="pt-BR">
<head>
  <meta charset="utf-8" />
  <meta name="viewport" content="width=device-width, initial-scale=1" />
  <title>Sistema de Roteiros - Adaptado ao JSON</title>

  <!-- Tailwind -->
  <script src="https://cdn.tailwindcss.com"></script>

  <!-- Fonte -->
  <link href="https://fonts.googleapis.com/css2?family=Inter:wght@100..900&display=swap" rel="stylesheet">

  <!-- CSS -->
  <link rel="stylesheet" href="styles.css">
</head>

<body class="h-screen">

  <!-- LOGO SISP (link para home) -->
  <a href="../paginatridigito.html">
    <img src="sisp-logo.png" alt="Logo SISP" id="sisp-logo" class="h-10 w-auto mr-3 cursor-pointer">
  </a>

  <main class="main-container flex h-full">

    <!-- SIDEBAR -->
    <aside class="sidebar w-full lg:w-1/4 p-4 overflow-y-auto">
      <input 
        id="search-input" 
        type="text" 
        placeholder="Buscar por Código, Título ou Descrição"
        class="w-full p-2 mb-4 border rounded-lg"
      >
      <div id="sidebar-menu" class="space-y-1"></div>
    </aside>

    <!-- ÁREA DE CONTEÚDO -->
    <section id="content-area-main" class="content-area w-full lg:w-3/4 p-6 overflow-y-auto">
      <div id="content-container">
        <h2 class="text-xl font-semibold text-blue-700">Selecione uma Natureza</h2>
        <p class="text-gray-500 mt-2">
          Use a barra de pesquisa ou o menu lateral para consultar uma natureza.
        </p>
      </div>
    </section>

  </main>

<script>
/*
  Página adaptada para funcionar com roteiros197.json (estrutura usada):
  Campos mapeados:
   - GRUPO -> grupo (se disponível)
   - NATUREZA -> codigo
   - TÍTULO -> titulo
   - DESCRIÇÃO -> descricao
   - AÇÕES -> acoes
   - ATENDIMENTO LOCAL PELA PC -> atendimento
   - LOCAL DE ENCERRAMENTO -> encerramento

  Fonte do JSON (enviada pelo usuário): roteiros197.json. fileciteturn5file0
*/

const contentContainer = document.getElementById("content-container");
const sidebarMenu = document.getElementById("sidebar-menu");
const searchInput = document.getElementById("search-input");

let roteiros = [];

// Carrega o JSON (deve estar na mesma pasta do index)
fetch('roteiros197.json')
  .then(resp => {
    if (!resp.ok) throw new Error('Não foi possível carregar roteiros197.json: ' + resp.status);
    return resp.json();
  })
  .then(data => {

    // Mapeia os objetos do JSON para o formato usado pela interface
    roteiros = data
      .filter(e => e && (e['NATUREZA'] || e['TÍTULO'])) // filtrar linhas vazias
      .map(e => {
        const grupo = (e['GRUPO'] || '').trim();
        const codigo = (e['NATUREZA'] || '').trim();
        const titulo = (e['TÍTULO'] || '').trim() || 'Sem título';
        const descricao = (e['DESCRIÇÃO'] || '').trim() || '';
        const acoes = (e['AÇÕES'] || '').trim() || '';
        const atendimento = (e['ATENDIMENTO LOCAL PELA PC'] || e['ATENDIMENTO LOCAL PELA PM'] || '').trim() || '';
        const encerramento = (e['LOCAL DE ENCERRAMENTO'] || '').trim() || '';
        const roteiro = [acoes, atendimento, encerramento].filter(Boolean).join('\n\n');
        return { grupo, codigo, titulo, descricao, acoes, atendimento, encerramento, roteiro };
      });

    renderSidebar(roteiros);
    renderContentArea('initial');
  })
  .catch(err => {
    contentContainer.innerHTML = '<div class="p-6 bg-red-50 text-red-700 rounded">Erro ao carregar dados: ' + err.message + '</div>';
    console.error(err);
  });

/* Renderiza o sidebar agrupando por GRUPO quando disponível, senão por inicial da NATUREZA */
function renderSidebar(data) {
  sidebarMenu.innerHTML = "";
  const groups = {};

  data.forEach(item => {
    // Preferir agrupamento por GRUPO (letra), senão usar inicial do código
    let key = (item.grupo && item.grupo.toUpperCase()) || (item.codigo ? item.codigo.charAt(0).toUpperCase() : 'Outros');
    if (!key) key = 'Outros';
    if (!groups[key]) groups[key] = [];
    groups[key].push(item);
  });

  Object.keys(groups).sort().forEach(key => {
    const div = document.createElement('div');
    div.className = 'group-header';
    div.dataset.group = key;
    div.textContent = key + ' (' + groups[key].length + ')';
    div.onclick = () => renderList(groups[key]);
    sidebarMenu.appendChild(div);
  });
}

function renderContentArea(type) {
  if (type === 'initial') {
    contentContainer.innerHTML = `
      <div class="p-8 text-center bg-white rounded-xl shadow-lg">
        <h2 class="text-3xl font-extrabold text-blue-700">Sistema de Roteiros</h2>
        <p class="text-lg text-gray-600 mt-4">Use a barra de pesquisa ou o menu lateral para consultar uma natureza.</p>
      </div>`;
  }
}

function renderList(list) {
  // Botão de voltar para a home (via logo já existe) - botão não incluído aqui
  contentContainer.innerHTML =
    `<h2 class="text-2xl font-bold mb-4 text-blue-700">Naturezas</h2>` +
    list.map(item =>
      `<div class="roteiro-item" data-codigo="${escapeHtml(item.codigo)}">
        <span class="codigo">${escapeHtml(item.codigo)}</span>
        <h4 class="text-blue-700">${escapeHtml(item.titulo)}</h4>
        <p>${escapeHtml(truncate(item.descricao, 200))}</p>
      </div>`
    ).join('');

  document.querySelectorAll('.roteiro-item').forEach(item =>
    item.onclick = () => renderDetails(item.dataset.codigo)
  );
}

function renderDetails(codigo) {
  const r = roteiros.find(x => x.codigo === codigo);
  if (!r) return;
  contentContainer.innerHTML = `
    <div class="bg-white p-6 rounded-xl shadow-xl">
      <span class="codigo">${escapeHtml(r.codigo)}</span>
      <h2 class="text-3xl font-bold text-blue-700">${escapeHtml(r.titulo)}</h2>
      <p class="text-gray-600">${escapeHtml(r.descricao)}</p>

      <h3 class="text-xl font-bold mt-6 text-blue-700">Roteiro</h3>
      <pre>${escapeHtml(r.roteiro)}</pre>

      <h3 class="text-xl font-bold mt-6 text-blue-700">Ações</h3>
      <pre>${escapeHtml(r.acoes)}</pre>

      <h3 class="text-xl font-bold mt-6 text-blue-700">Atendimento local</h3>
      <pre>${escapeHtml(r.atendimento)}</pre>

      <h3 class="text-xl font-bold mt-6 text-blue-700">Local de encerramento</h3>
      <pre>${escapeHtml(r.encerramento)}</pre>

      <button onclick="renderContentArea('initial')" class="text-blue-600 mt-6">← Voltar</button>
    </div>
  `;
}

searchInput.onkeyup = () => {
  const t = searchInput.value.toLowerCase().trim();
  if (!t) return renderContentArea('initial');
  const filtered = roteiros.filter(r =>
    (r.codigo || '').toLowerCase().includes(t) ||
    (r.titulo || '').toLowerCase().includes(t) ||
    (r.descricao || '').toLowerCase().includes(t)
  );
  renderList(filtered);
};

// Helpers
function escapeHtml(str) {
  if (!str) return '';
  return String(str)
    .replaceAll('&', '&amp;')
    .replaceAll('<', '&lt;')
    .replaceAll('>', '&gt;');
}
function truncate(s, n){ if(!s) return ''; return s.length>n? s.slice(0,n-1)+'…': s; }

</script>
</body>
</html>
